name: Generate API Client

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to update'
        required: false
        default: 'main'
      tool_branch:
        description: 'pv-auto-client branch/tag to use'
        required: false
        default: 'main'
      overwrite_build:
        description: 'Overwrite existing build.yaml'
        required: false
        type: boolean
        default: false

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch || 'main' }}
          fetch-depth: 0
      
      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      
      - name: Cache Dart packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-dart-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-dart-
      
      - name: Install pv-auto-client
        run: |
          dart pub global activate --source git https://github.com/Pathverse/pv-auto-client.git \
            --git-ref ${{ github.event.inputs.tool_branch || 'main' }} \
            --overwrite
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          XAPIKEY=${{ secrets.POSTMAN_API_KEY }}
          XCOID=${{ secrets.POSTMAN_COLLECTION_UID }}
          EOF
      
      - name: Run pv-auto-client
        run: |
          pv_auto_client auto \
            --target ${{ github.workspace }} \
            --overwrite-dependencies \
            ${{ github.event.inputs.overwrite_build == 'true' && '--overwrite-build' || '' }} \
            --delete-conflicting
      
      - name: Clean up empty model part directives
        run: |
          # Find all .dart files in lib/ that contain part directives
          find lib -name "*.dart" -type f | while read -r dart_file; do
            # Extract part directives from the file
            grep "^part '[^']*\.g\.dart';" "$dart_file" 2>/dev/null | while read -r part_line; do
              # Extract the .g.dart filename from the part directive
              g_file=$(echo "$part_line" | sed -n "s/^part '\([^']*\)';$/\1/p")
              
              if [ -n "$g_file" ]; then
                # Get the directory of the current dart file
                dart_dir=$(dirname "$dart_file")
                g_file_path="$dart_dir/$g_file"
                
                # Check if .g.dart file doesn't exist or is empty
                if [ ! -f "$g_file_path" ] || [ ! -s "$g_file_path" ]; then
                  echo "Removing part directive from $dart_file (generated file $g_file_path missing or empty)"
                  # Escape special characters for sed
                  escaped_line=$(echo "$part_line" | sed 's/[\/&]/\\&/g')
                  sed -i "/^${escaped_line}$/d" "$dart_file"
                fi
              fi
            done
          done
      
      - name: Check for changes
        id: check_changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi
      
      - name: Commit and push to main
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: regenerate API client from Postman collection"
          git push origin ${{ github.event.inputs.target_branch || 'main' }}
      
      - name: Create date-based mirror branch
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          DATE_BRANCH="generated-$(date +'%Y-%m-%d')"
          COUNTER=1
          BRANCH_NAME="$DATE_BRANCH"
          
          # Check if branch exists and increment counter if needed
          while git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; do
            BRANCH_NAME="${DATE_BRANCH}-${COUNTER}"
            COUNTER=$((COUNTER + 1))
          done
          
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
